# 服务器代码重构说明

## 目录结构

```
server/
├── app.py                 # 原始的单文件服务器（已备份）
├── app_new.py             # 新的模块化服务器（推荐使用，功能完整）
├── games/                 # 游戏逻辑模块
│   ├── __init__.py
│   ├── gobang.py          # 五子棋
│   ├── chinese_chess.py   # 中国象棋
│   ├── go.py              # 围棋
│   ├── othello.py         # 黑白棋
│   ├── army_chess.py      # 军棋（完整版）
│   └── doudizhu.py        # 斗地主（完整版）
└── requirements.txt
```

## 模块说明

### 主程序 (app_new.py)

- Flask和SocketIO初始化
- WebSocket事件路由
- 房间管理
- 游戏状态管理
- 玩家连接/断开处理

### 游戏模块

每个游戏模块包含：
- 棋盘初始化函数
- 移动验证函数
- 游戏逻辑处理函数
- 游戏重置函数

## 使用方法

### 启动服务器

```bash
cd server
python app_new.py
```

### 将原始代码替换为新代码

1. 备份原始文件：
```bash
cp app.py app_backup.py
```

2. 替换新文件：
```bash
mv app_new.py app.py
```

## 功能完整性说明

### 军棋 (army_chess.py) - 完整版

**已实现所有功能：**
✅ 工兵沿铁路移动（包括转弯路径）
✅ 使用BFS算法计算工兵铁路路径
✅ 其他棋子铁路直行移动
✅ 从行营到行营的斜向移动（相邻行营）
✅ 从行营到相邻格子的斜向移动
✅ 从相邻格子到行营的斜向移动
✅ 大本营限制（大本营中的棋子不能移动）
✅ 行营保护（行营中的棋子不能被攻击）
✅ 战斗逻辑（炸弹、地雷、军旗特殊规则）
✅ 上一步移动路径显示（含工兵铁路路径）
✅ 阵亡棋子记录和通知
✅ 夺取军旗获胜判定

### 斗地主 (doudizhu.py) - 完整版

**已实现所有牌型验证：**
✅ 单张
✅ 对子
✅ 王炸
✅ 三张
✅ 三带一
✅ 三带二（带对子）
✅ 炸弹
✅ 顺子（5-12张连续单牌，不能含2和王）
✅ 连对（3对以上连续对子，不能含2和王）
✅ 飞机不带（2组以上连续三张，不能含2和王）
✅ 飞机带单（2组以上连续三张带单张，不能含2和王）
✅ 飞机带对（2组以上连续三张带对子，不能含2和王）
✅ 四带二单（四张带两张单牌）
✅ 四带二对（四张带两个对子）

### 其他游戏

- **五子棋 (gobang.py)**: 完整实现
- **中国象棋 (chinese_chess.py)**: 完整实现
- **围棋 (go.py)**: 完整实现
- **黑白棋 (othello.py)**: 完整实现

## 依赖项

确保安装了所需的依赖：

```bash
pip install flask flask-socketio flask-cors eventlet
```

## 优势

1. **代码组织清晰**：每个游戏独立模块，易于维护
2. **便于扩展**：添加新游戏只需创建新模块
3. **代码复用**：通用函数可以提取到工具模块
4. **便于测试**：可以单独测试每个游戏模块
5. **团队协作**：不同开发者可以同时修改不同游戏
6. **功能完整**：所有游戏功能已完整移植，无功能缺失

## 技术实现细节

### 军棋铁路移动算法

- 使用BFS（广度优先搜索）算法查找工兵在铁路上的可达路径
- 支持铁路网络中的拐弯移动
- 自动检测路径上的棋子阻挡
- 返回完整路径用于客户端显示箭头

### 斗地主牌型验证

- 支持所有标准斗地主牌型
- 严格的牌型匹配规则
- 正确的顺子和连对检测（排除2和王）
- 飞机系列的多种变体支持

## 后续改进建议

1. 提取通用的游戏基类
2. 添加单元测试
3. 添加数据库支持（保存游戏记录）
4. 添加用户认证系统
5. 添加观战模式
6. 添加回放功能
